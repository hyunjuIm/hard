<!DOCTYPE HTML>
<html>
<head>
    <title>듀얼헬스케어:패키지검사항목구성</title>

    <% include menu-head %>

</head>

<body>

<!--상단 네비바-->
<header>
    <% include top-menu %>
</header>
<!--상단 네비바-->

<!--콘텐츠 내용-->
<div class="container" style="padding-top: 50px; max-width: none">
    <div class="row">
        <div class="col-7" style="margin: 0 auto; padding: 20px">
            <form class="table-box">
                <div class="menu-title" style="font-size: 22px; margin-bottom: 20px">
                    <img src="images/bg_h2_tit.png" style="margin-right: 10px;">
                    패키지구성
                </div>

                <ul class="nav nav-tabs package-tabs">
                    <li class="nav-item" id="allPackageTab" onclick="clickTab(id)">
                        <a class="nav-link active" data-toggle="tab" href="#" onclick="clickPackageTab(0)">전체</a>
                    </li>
                    <li class="nav-item" id="basePackageTab" onclick="clickTab(id)">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickPackageTab(1)">기본</a>
                    </li>
                    <li class="nav-item" id="addPackageTab" onclick="clickTab(id)">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickPackageTab(2)">추가</a>
                    </li>
                    <li class="nav-item menu-title" id="selectPackageA" style="display: none" onclick="clickTab(id)">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickPackageTab(3)">선택A</a>
                    </li>
                    <li class="nav-item" id="selectPackageB" style="display: none" onclick="clickTab(id)">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickPackageTab(4)">선택B</a>
                    </li>
                    <li class="nav-item" id="selectPackageC" style="display: none" onclick="clickTab(id)">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickPackageTab(5)">선택C</a>
                    </li>
                    <li class="nav-item" id="selectPackageD" style="display: none" onclick="clickTab(id)">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickPackageTab(6)">선택D</a>
                    </li>
                    <li class="nav-item" id="addTab">
                        <a class="nav-link" data-toggle="tab" href="#addTab" style="font-weight: bold; background: #E6E6E6"
                        onclick="addPackageTab()">+</a>
                    </li>
                </ul>
                <div class="tab-content" style="height: 400px; overflow-y: scroll">
                    <div class="tab-pane fade show active" id="packageTab">
                        <table id="packageTable">
                            <thead>
                            <tr>
                                <th style="width: 5%"><input type="checkbox" id="packageCheck" name="packageCheck" onclick="clickAll(id, name)"></th>
                                <th>세부항목</th>
                                <th>검사명</th>
                                <th>구분</th>
                                <th>성별</th>
                                <th>추가금</th>
                                <th>비고</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

            </form>
        </div>
        <div class="col-xs-auto" style="margin-top: 15%">
            <div style="display: grid; justify-content: center; align-items: center">
                <div class="btn-purple-square" style="font-size: 18px; padding: 5px 10px; margin-bottom: 5px"> ▶ </div>
                <div class="btn-purple-square" style="font-size: 18px; padding: 5px 10px"
                onclick="addInjection()"> ◀ </div>
            </div>
        </div>
        <div class="col" style="margin: 0 auto; padding: 20px">
            <form class="table-box">
                <div class="menu-title" style="font-size: 22px; margin-bottom: 20px">
                    <img src="images/bg_h2_tit.png" style="margin-right: 10px;">
                    검사항목
                </div>
                <div class="search" style="float: right;width: 250px">
                    <input type="text" id="searchInjectionWord" class="search-input" placeholder="검사명으로 검색하세요">
                    <div class="search-icon" onclick="searchInjection()"></div>
                </div>

                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#" onclick="clickInjectionTab(0)" >전체</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickInjectionTab(1)">기본</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickInjectionTab(2)">혈액</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickInjectionTab(3)">장비</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#" onclick="clickInjectionTab(4)">기타</a>
                    </li>
                </ul>
                <div class="tab-content" style="height: 400px; overflow-y: scroll">
                    <div class="tab-pane fade show active" id="injectionTab">
                        <table id="injectionTable">
                            <thead>
                            <tr>
                                <th style="width: 7%"><input type="checkbox" id="injectionCheck" name="injectionCheck" onclick="clickAll(id, name)"></th>
                                <th>세부항목</th>
                                <th>검사명</th>
                                <th>관리코드</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <hr>
    <div class="row" style="padding: 20px">
        <div style="margin: 0 auto">
            <div class="btn-save-square" style="font-size: 18px; padding: 7px 40px; margin-right: 20px" onclick="">
                저장
            </div>
            <div class="btn-cancel-square" style="font-size: 18px; padding: 7px 40px;" onclick="">
                취소
            </div>
        </div>
    </div>
</div>
<!--콘텐츠 내용-->

<% include test.ejs %>

</body>
</html>

<script type="text/javascript">

    //선택항목 탭
    function addPackageTab() {
        if ($("#selectPackageA").css("display") == "none") {
            $("#selectPackageA").show();
        } else {
            if ($("#selectPackageB").css("display") == "none") {
                $("#selectPackageB").show();
            } else {
                if ($("#selectPackageC").css("display") == "none") {
                    $("#selectPackageC").show();
                } else {
                    if ($("#selectPackageD").css("display") == "none") {
                        $("#selectPackageD").show();
                        $("#addTab").hide();
                    } else {
                        alert("더이상 추가할 수 없습니다.");
                    }
                }
            }
        }
    }

    //검사항목 리스트
    instance.post('M008001_RES', new Object()).then(res => {
        setInjectionData(res.data);
    });

    //체크박스 전체 선택
    function clickAll(id, name) {
        var clickId = "#" + id;
        var clickName = "input[name=" + name + "]";

        if ($(clickId).is(':checked')) {
            $(clickName).prop("checked", true);
        }
        else {
            $(clickName).prop("checked", false);
        }
    }

    //체크박스 하나라도 취소되면 전체 선택 해지
    function clickOne(name) {
        var clickId = "#" + name;
        var clickIdInput = "input[id="+ name +"]"
        var clickName = "[name="+ name +"]:checked"

        if($(clickId).is(':checked').length == $(clickName).length) {
            $(clickIdInput).prop("checked", true);
        }
        else {
            $(clickIdInput).prop("checked", false);
        }
    }

    //검사항목 배열
    var injectionItems = new Array();

    //검사항목 탭 전환
    function clickInjectionTab(id){
        $("#injectionTable tbody").empty();

        for (i = 0; i < injectionItems[id].length; i++) {
            var value = injectionItems[id][i].details + "#" + injectionItems[id][i].inspection + "#" + injectionItems[id][i].code;
            var html = '';
            html += '<tr>"';
            html += '<td><input type="checkbox" name="injectionCheck" onclick="clickOne(name)" value = \'' + value + '\'></td>';
            html += '<td>' + injectionItems[id][i].details + '</td>';
            html += '<td>' + injectionItems[id][i].inspection + '</td>';
            html += '<td>' + injectionItems[id][i].code + '</td>';
            html += '</tr>';

            $("#injectionTable").append(html);
        }
    }

    //검사항목 초기 셋팅
    function setInjectionData(data) {
        var injection0 = new Array();
        var injection1 = new Array();
        var injection2 = new Array();
        var injection3 = new Array();
        var injection4 = new Array();

        for (i = 0; i < data.length; i++) {
            var value = data[i].details + "#" + data[i].inspection + "#" + data[i].code;
            var html = '';
            html += '<tr>"';
            html += '<td><input type="checkbox" name="injectionCheck" onclick="clickOne(name)" value = \'' +value + '\'></td>';
            html += '<td>' + data[i].details + '</td>';
            html += '<td>' + data[i].inspection + '</td>';
            html += '<td>' + data[i].code + '</td>';
            html += '</tr>';

            $("#injectionTable").append(html);

            injection0.push(data[i])
            if (data[i].division == "기본검사") {
                injection1.push(data[i]);
            } else if (data[i].division == "혈액검사") {
                injection2.push(data[i]);
            } else if (data[i].division == "장비검사") {
                injection3.push(data[i]);
            } else {
                injection4.push(data[i]);
            }
        }

        injectionItems[0] = injection0;
        injectionItems[1] = injection1;
        injectionItems[2] = injection2;
        injectionItems[3] = injection3;
        injectionItems[4] = injection4;
    }

    //검사항목 검색
    function searchInjection() {
        $('#injectionTable > tbody').empty();

        var search = new Object();
        search.searchWord =  $("#searchInjectionWord").val();

        //검사항목리스트
        instance.post('M008001_RES', search).then(res => {
            setInjectionData(res.data);
        });
    }

    //선택한 탭 확인 (해당 탭 클릭)
    function clickTab(id) {
        console.log(id);
    }

    var pkgId = "PKG#52";
    //패키지구성 리스트
    instance.post('M008003_REQ_RES', pkgId).then(res => {
        setPackageTabData(res.data);
    });

    //패키지구성 배열
    var packageTabItems = new Array();

    //패키지구성 초기 셋팅
    function setPackageTabData(data) {
        var package0 = new Array();
        var package1 = new Array();
        var package2 = new Array();
        var package3 = new Array();
        var package4 = new Array();
        var package5 = new Array();
        var package6 = new Array();

        for (i = 0; i < data.length; i++) {
            var html = '';
            html += '<tr>"';
            html += '<td><input type="checkbox" name="injectionCheck" onclick="clickOne(name)" value = \'' +0 + '\'></td>';
            html += '<td>' + data[i].id + '</td>';
            html += '<td>' + data[i].ipCode + '</td>';
            html += '<td>' + data[i].sex + '</td>';
            html += '<td>' + data[i].price + '</td>';
            html += '<td>' + data[i].memo + '</td>';
            html += '</tr>';

            $("#packageTable").append(html);

            package0.push(data[i])
            if (data[i].ipClass == "기본검사") {
                package1.push(data[i]);
            } else if (data[i].ipClass == "추가검사") {
                package2.push(data[i]);
            } else if (data[i].ipClass == "선택A") {
                package3.push(data[i]);
            } else if (data[i].ipClass == "선택B") {
                package4.push(data[i]);
            } else if (data[i].ipClass == "선택C") {
                package5.push(data[i]);
            } else if (data[i].ipClass == "선택D") {
                package6.push(data[i]);
            }
        }

        packageTabItems[0] = package0;
        packageTabItems[1] = package1;
        packageTabItems[2] = package2;
        packageTabItems[3] = package3;
        packageTabItems[4] = package4;
        packageTabItems[5] = package5;
        packageTabItems[6] = package6;
    }

    //패키지구성 탭 전환
    function clickPackageTab(id){
        $("#packageTable tbody").empty();

        for (i = 0; i < injectionItems[id].length; i++) {
            var value = injectionItems[id][i].details + "#" + injectionItems[id][i].inspection + "#" + injectionItems[id][i].code;
            var html = '';
            html += '<tr>"';
            html += '<td><input type="checkbox" name="injectionCheck" onclick="clickOne(name)" value = \'' + value + '\'></td>';
            html += '<td>' + injectionItems[id][i].details + '</td>';
            html += '<td>' + injectionItems[id][i].inspection + '</td>';
            html += '<td>' + injectionItems[id][i].code + '</td>';
            html += '</tr>';

            $("#packageTable").append(html);
        }
    }

    //패키지구성에서 검사항목 구분 셀럭터 선택
    function changeIpClass(value) {
        console.log(value);

        if (value == "기본검사") {
            clickPackageTab(0);
        } else if (value == "추가검사") {
            clickPackageTab(1);
        } else if (value == "선택A") {
            clickPackageTab(2);
        } else if (value == "선택B") {
            clickPackageTab(3);
        } else if (value == "선택C") {
            clickPackageTab(4);
        } else if (value == "선택D") {
            clickPackageTab(5);
        }
    }

    var injectionCode = new Array();
    //검사항목 추가
    function addInjection() {
        var ipClass = '<td><select class="form-control" name="ipClass" onclick="changeIpClass(value)">' +
            '<option>선택</option>' +
            '<option>기본검사</option>' +
            '<option>추가검사</option>' +
            '</select></td>';
        var sex = '<td><select class="form-control" name="sex">' +
            '<option>전체</option>' +
            '<option>남</option>' +
            '<option>여</option>' +
            '</select></td>';

        $("input:checkbox[name=injectionCheck]:checked").each(function (index) {
            if($(this).val() != "on") {
                var value = $(this).val();
                var values = value.split("#");
                var check = 0;

                for(i=0; i<injectionCode.length; i++) {
                    if(injectionCode[i] == values[2]) {
                        alert("검사명 : " + values[1] + "\n중복입니다. 다시 확인해주세요.");
                        check++;
                    }
                }

                //중복 아닌 검사항목만 추가
                if(check == 0) {
                    injectionCode.push(values[2]);

                    var html = ""
                    html += '<tr>"';
                    html += '<td><input type="checkbox" name="packageCheck" onclick="clickOne(name)" value = \'' +values[2] + '\'></td>';
                    html += '<td>' + values[0] + '</td>';
                    html += '<td>' + values[1] + '</td>';
                    html += ipClass;
                    html += sex;
                    html += '<td contentEditable="true"></td>';
                    html += '<td contentEditable="true"></td>';
                    html += '</tr>';

                    $("#packageTable").append(html);
                }

                $("input:checkbox[name=injectionCheck]:checked").prop("checked", false);
            }
        });
    }
</script>
