<!DOCTYPE HTML>
<html>
<head>
    <title>듀얼헬스케어:예약관리</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,Array.prototype.includes,Array.prototype.find"></script>
    <!--for ajax-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        ul {
            list-style: none;
        }

        .col-form-label {
            font-size: 18px;
            min-width: 130px;
        }

        table {
            text-align: center;
            margin: auto;
            vertical-align: middle;
            border-collapse: collapse;
            line-height: 30px;
            border-bottom: #E6E6E6 1px solid;
        }

        th {
            width: 150px;
            background: #E6E6E6;
            color: #444444;
            font-size: 17px;
        }

        tr {
            color: #444;
        }

        td {
            width: 250px;
            border: 1px;
            solid: #efefef;
            font-size: 15px;
            vertical-align: middle;
        }

    </style>

</head>

<body>

<!--상단 네비바-->
<header>
    <% include top-menu %>
</header>
<!--상단 네비바-->

<!--콘텐츠 내용-->
<div class="container" style="padding-top: 50px; max-width: none">
    <div class="row">
        <div class="col">
            <form style="margin: 0 auto; width: 95%; max-width: 1150px; padding: 20px">
                <ul class="img-circle">
                    <div class="menu-title" style="font-size: 22px">
                        <img src="images/bg_h2_tit.png" style="margin-right: 10px;">
                        예약관리
                    </div>
                    <hr>
                    <div class="form-row row">
                        <label class="col-form-label">
                            <li>수검연도</li>
                        </label>
                        <div class="form-group col">
                            <select id="servedYear" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                        <label class="col-form-label" style="margin-left: 20px">
                            <li>서비스</li>
                        </label>
                        <div class="form-group col">
                            <select id="reservationServiceName" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row row">
                        <label class="col-form-label">
                            <li>회사명</li>
                        </label>
                        <div class="form-group col">
                            <select id="companyName" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                        <label class="col-form-label" style="margin-left: 20px">
                            <li>지점</li>
                        </label>
                        <div class="form-group col">
                            <select id="companyBranch" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row row">
                        <label class="col-form-label">
                            <li>진행 상태</li>
                        </label>
                        <div class="form-group col">
                            <select id="reservationStatus" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                        <label class="col-form-label" style="margin-left: 20px">
                            <li>병원명</li>
                        </label>
                        <div class="form-group col">
                            <select id="hospitalName" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <a class="btn-purple-square modal-toggle5" style="float: right;" onclick="searchInformation()">검색</a>
                </ul>
            </form>
        </div>
    </div>

    <div class="row" style="margin-top:100px">
        <div class="col">
            <div class="d-flex justify-content-center px-5">
                <h6><a style="margin-right: 15px">통합검색</a>
                    <div class="search">
                        <input type="text" class="search-input" placeholder="사원번호, 이름으로 검색하세요" name="">
                        <a href="#" class="search-icon"> <i class="fa fa-search"></i> </a>
                    </div>
                </h6>
            </div>
        </div>
    </div>

    <div class="row " style="margin-left: 30px; margin-right: 30px; margin-top: 20px">
        <form class="table-responsive" style="margin: 0 auto">
            <a href="#" class="btn-default-small excel" style="float: right"></a>
            <table id="reservationInfos" class="table table-hover" style="margin-top: 45px">
                <thead>
                <tr>
                    <th scope="col">NO</th>
                    <th scope="col">서비스</th>
                    <th scope="col">고객사</th>
                    <th scope="col">사업장</th>
                    <th scope="col">아이디<br>(사번)</th>
                    <th scope="col">성명</th>
                    <th scope="col">등급</th>
                    <th scope="col">생년월일</th>
                    <th scope="col">검진병원</th>
                    <th scope="col">연락처</th>
                    <th scope="col">예약일</th>
                    <th scope="col">수검<br>상태</th>
                    <th scope="col">패키지</th>
                    <th scope="col">패키지<br>금액</th>
                    <th scope="col">지원금</th>
                    <th scope="col">개인정보 동의<br>(듀얼)</th>
                    <th scope="col">개인정보 동의<br>(병원)</th>
                    <th scope="col">공단<br>차감</th>
                </tr>
                </thead>
                <tbody>
                    <tr>

                    </tr>
                </tbody>
            </table>
        </form>

    </div>

</div>
<!--콘텐츠 내용-->


<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 100%; width: auto; display: table;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container" style="margin-top: 20px">
                    <div class="menu-title" style="font-size: 22px; margin-bottom: 20px">
                        <img src="images/bg_h2_tit.png" style="margin-right: 10px;">
                        고객정보
                    </div>
                    <div class="row">
                        <div class="col">
                            <table class="table" id="info1">
                                <tbody>
                                <tr>
                                    <th>소속</th>
                                    <td id="cus-companyName"></td>
                                </tr>
                                <tr>
                                    <th>부서</th>
                                    <td id="cus-companyBranch"></td>
                                </tr>
                                <tr>
                                    <th>성명</th>
                                    <td id="cus-familyName" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>생년월일</th>
                                    <td id="cus-familyBirthDate" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>연락처</th>
                                    <td id="cus-familyPhone" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>주소</th>
                                    <td id="cus-familyAddress" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>이메일</th>
                                    <td id="cus-familyEmail" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>공단대상</th>
                                    <td id="cus-familyPcDiscount" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>듀얼(동의)</th>
                                    <td id="cus-familyPsInfoDual" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>병원(동의)</th>
                                    <td id="cus-familyPsInfoHos" contentEditable="true"></td>
                                </tr>
                                </tbody>
                            </table>

                            <div id="cus-packageReservation" style="font-size:15px; color: #5645ed"></div>

                            <table class="table" id="info2">
                                <tbody>
                                <tr>
                                    <th>1차 예약일</th>
                                    <td id="cus-reservationFirstWishDate" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>2차 예약일</th>
                                    <td id="cus-reservationSecondWishDate" contentEditable="true"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col">
                            <table class="table" id="info3">
                                <tbody>
                                <tr>
                                    <th>예약서비스</th>
                                    <td id="cus-packageServiceName"></td>
                                </tr>
                                <tr>
                                    <th>병원</th>
                                    <td id="cus-packageHospitalName"></td>
                                </tr>
                                <tr>
                                    <th>패키지</th>
                                    <td id="cus-packageName"></td>
                                </tr>
                                <tr>
                                    <th>선택검사</th>
                                    <td id="cus-piiClassList"></td>
                                </tr>
                                <tr>
                                    <th>추가검사</th>
                                    <td id="cus-piiList"></td>
                                </tr>
                                </tbody>
                            </table>
                            <table class="table" id="info4">
                                <tbody>
                                <tr>
                                    <th>패키지금액</th>
                                    <td id="cus-packagePrice"></td>
                                </tr>
                                <tr>
                                    <th>회사지원금</th>
                                    <td id="cus-companySupportPrice" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>본인부담금</th>
                                    <td id="cus-customerPayedPrice"></td>
                                </tr>
                                </tbody>
                            </table>
                            <table class="table" id="info5">
                                <tbody>
                                <tr>
                                    <th>메모</th>
                                    <td id="cus-memo" contentEditable="true"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <a href="#" class="btn-save-square modal-toggle5" style="float: right;" onclick="saveInformation()">저장</a>
            </div>
        </div>
    </div>
</div>

</body>
</html>

<script type="text/javascript">
    var token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJMU0giLCJleHAiOjE2MDMwOTU5MzJ9.ZrwYNSVhfzpHPxEI01PQ757Z7hvaFr1jDRiEvKFvb7U";
    const instance = axios.create({
        baseURL: 'https://api.careroom.kr/master/api/v1/',
        timeout: 1000,
        headers: {'token': token}
    });
    //검색항목리스트
    instance.post('M003001_RES').then(res => {
        setReservationSelectData(res.data);
    });


    //검색
    function searchInformation(){
        var searchItems = new Object();

        $( '#reservationInfos > tbody').empty();

        searchItems.servedYear = $("#servedYear option:selected").val();
        searchItems.reservationServiceName = $("#reservationServiceName option:selected").val();
        searchItems.companyName = $("#companyName option:selected").val();
        searchItems.companyBranch = $("#companyBranch option:selected").val();
        searchItems.reservationStatus = $("#reservationStatus option:selected").val();
        searchItems.hospitalName = $("#hospitalName option:selected").val();

        if(searchItems.servedYear == "-전체-") {
            searchItems.servedYear = "all";
        }
        if(searchItems.reservationServiceName == "-전체-") {
            searchItems.reservationServiceName = "all";
        }
        if(searchItems.companyName == "-전체-") {
            searchItems.companyName = "all";
        }
        if(searchItems.companyBranch == "-전체-") {
            searchItems.companyBranch = "all";
        }
        if(searchItems.reservationStatus == "-전체-") {
            searchItems.reservationStatus = "all";
        }
        if(searchItems.hospitalName == "-전체-") {
            searchItems.hospitalName = "all";
        }

        instance.post('M003002_REQ_RES',searchItems).then(res => {
            setReservationData(res.data);
        });
    }

    //고객정보상세
    var rsvId = Object();
    function clickDetail(data){
        rsvId.reservationId = data;
        instance.post('M003003_REQ_RES', rsvId).then(res => {
            setDetailCostomerData(res.data);
        });
    }

    //예약관리 selector
    function setReservationSelectData(data) {
        //수검연도
        for(i=0; i<data.servedYear.length; i++){
            var html = '';
            html += '<option>'+data.servedYear[i]+'</option>'
            $("#servedYear").append(html);
        }
        //병원별
        for(i=0; i<data.reservationServiceName.length; i++){
            var html = '';
            html += '<option>'+data.reservationServiceName[i]+'</option>'
            $("#reservationServiceName").append(html);
        }
        //회사
        if(data.companyName.length > 0) {
            //회사명 - 지점있을때
            var jbSplit = data.companyName[0].split('-');
            var companyName = jbSplit[0];
            var html = '';
            html += '<option>' + companyName + '</option>'
            $("#companyName").append(html);

            for(i=0; i<data.companyName.length; i++) {
                var jbSplit = data.companyName[i].split('-');
                var companyBranch = jbSplit[jbSplit.length-1];
                var html = '';
                html += '<option>'+companyBranch+'</option>'
                $("#companyBranch").append(html);
            }
        } else {
            //회사명 - 지점없을때
            for(i=0; i<data.companyName.length; i++) {
                var html = '';
                html += '<option>' + data.companyName[i] + '</option>'
                $("#companyName").append(html);
            }
        }
        //진행상태
        for(i=0; i<data.reservationStatus.length; i++){
            var html = '';
            html += '<option>'+data.reservationStatus[i]+'</option>'
            $("#reservationStatus").append(html);
        }
        //병원명
        for(i=0; i<data.hospitalName.length; i++){
            var html = '';
            html += '<option>'+data.hospitalName[i]+'</option>'
            $("#hospitalName").append(html);
        }
    }

    //예약관리 테이블
    function setReservationData(data) {
        for (i = 0; i < data.length; i++) {
            var html = '';
            html += '<tr>"';
            html += '<td>' + data[i].id + '</td>';
            html += '<td>' + data[i].serviceName + '</td>';
            html += '<td>' + data[i].companyName + '</td>';
            html += '<td>' + data[i].companyBranch + '</td>';
            html += '<td data-toggle="modal" data-target="#exampleModal" onClick="clickDetail(\'' + data[i].id + '\')">' + data[i].familyId + '</td>';
            html += '<td>' + data[i].familyName + '</td>';
            html += '<td>' + data[i].familyGrade + '</td>';
            html += '<td>' + data[i].familyBirthDate + '</td>';
            html += '<td>' + data[i].hospitalName + '</td>';
            html += '<td>' + data[i].familyPhone;
            html += '<td>' + data[i].firstWishDate;
            html += '<p>' + data[i].secondWishDate + '</p></td>';

            if(data[i].ipCheck) {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" checked disabled="disabled"></td>';
            }else {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" disabled="disabled"></td>';
            }

            html += '<td>' + data[i].packageName + '</td>';
            html += '<td>' + data[i].packagePrice + '</td>';
            html += '<td>' + data[i].companySupportPrice + '</td>';

            if(data[i].familyPsInfoCheckDual) {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" checked disabled="disabled"></td>';
            }else {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" disabled="disabled"></td>';
            }

            if(data[i].familyPsInfoCheckHos) {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" checked disabled="disabled"></td>';
            }else {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" disabled="disabled"></td>';
            }

            if(data[i].familyPcDiscount) {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" checked disabled="disabled"></td>';
            }else {
                html += '<td><input class="form-check-input ipCheck" type="checkbox" disabled="disabled"></td>';
            }

            html += '</tr>';

            $("#reservationInfos").append(html);
        }
    }

    //클릭시 고객정보
    function setDetailCostomerData(data) {
        //info1
        document.getElementById('cus-companyName').innerHTML = data.companyName;
        document.getElementById('cus-companyBranch').innerHTML = data.companyBranch;
        document.getElementById('cus-familyName').innerHTML = data.familyName;
        document.getElementById('cus-familyBirthDate').innerHTML = data.familyBirthDate;
        document.getElementById('cus-familyPhone').innerHTML = data.familyPhone;
        document.getElementById('cus-familyAddress').innerHTML = data.familyAddress;
        document.getElementById('cus-familyEmail').innerHTML = data.familyEmail;
        document.getElementById('cus-familyPcDiscount').innerHTML = data.familyPcDiscount;
        document.getElementById('cus-familyPsInfoDual').innerHTML = data.familyPsInfoDual;
        document.getElementById('cus-familyPsInfoHos').innerHTML = data.familyPsInfoHos;

        //info2
        document.getElementById('cus-packageReservation').innerHTML
            = "예약기간 : " + data.packageReservationStartDate + " ~ " + data.packageReservationEndDate;
        document.getElementById('cus-reservationFirstWishDate').innerHTML = data.reservationFirstWishDate;
        document.getElementById('cus-reservationSecondWishDate').innerHTML = data.reservationSecondWishDate;

        //info3
        document.getElementById('cus-packageServiceName').innerHTML = data.packageServiceName;
        document.getElementById('cus-packageHospitalName').innerHTML = data.packageHospitalName;
        document.getElementById('cus-packageName').innerHTML = data.packageName;
        document.getElementById('cus-piiClassList').innerHTML = data.piiClassList;
        document.getElementById('cus-piiList').innerHTML = data.piiList;

        //info4
        document.getElementById('cus-packagePrice').innerHTML = data.packagePrice;
        document.getElementById('cus-companySupportPrice').innerHTML = data.companySupportPrice;
        document.getElementById('cus-customerPayedPrice').innerHTML = data.customerPayedPrice;

        //info5
        document.getElementById('cus-memo').innerHTML = data.memo;
    }

    //수정된 정보로 저장
    function saveInformation() {
        var saveItems = new Object();

        saveItems.reservationId = rsvId.reservationId;
        saveItems.familyName = document.getElementById('cus-familyName').outerHTML;
        saveItems.familyBirthDate = document.getElementById('cus-familyBirthDate').outerHTML;
        saveItems.familyPhone = document.getElementById('cus-familyPhone').outerHTML;
        saveItems.familyAddress = document.getElementById('cus-familyAddress').outerHTML;
        saveItems.familyEmail = document.getElementById('cus-familyEmail').outerHTML;
        saveItems.familyPcDiscount = document.getElementById('cus-familyPcDiscount').outerHTML;
        saveItems.familyPsInfoDual = document.getElementById('cus-familyPsInfoDual').outerHTML;
        saveItems.familyPsInfoHos = document.getElementById('cus-familyPsInfoHos').outerHTML;
        saveItems.reservationFirstWishDate = document.getElementById('cus-reservationFirstWishDate').outerHTML;
        saveItems.reservationSecondWishDate = document.getElementById('cus-reservationSecondWishDate').outerHTML;
        saveItems.companySupportPrice = document.getElementById('cus-companySupportPrice').outerHTML;
        saveItems.memo = document.getElementById('cus-memo').outerHTML;

        //TODO: api 오류 확인
        instance.post('M003004_REQ_RES', saveItems).then(res => {
            console.log(res.data,  "저장성공");
        });
    }
</script>
