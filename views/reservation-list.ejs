<!DOCTYPE HTML>
<html>
<head>
    <title>듀얼헬스케어:예약관리</title>

    <% include menu-head %>

</head>

<body>

<!--상단 네비바-->
<header>
    <% include top-menu %>
</header>
<!--상단 네비바-->

<!--콘텐츠 내용-->
<div class="container" style="padding-top: 50px; max-width: none">
    <div class="row">
        <div class="col">
            <form style="margin: 0 auto; width: 95%; max-width: 1150px; padding: 20px">
                <ul class="img-circle">
                    <div class="menu-title" style="font-size: 22px">
                        <img src="images/bg_h2_tit.png" style="margin-right: 10px;">
                        예약관리
                    </div>
                    <hr>
                    <div class="form-row row">
                        <label class="col-form-label">
                            <li>수검연도</li>
                        </label>
                        <div class="form-group col">
                            <select id="servedYear" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                        <label class="col-form-label" style="margin-left: 20px">
                            <li>서비스</li>
                        </label>
                        <div class="form-group col">
                            <select id="reservationServiceName" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row row">
                        <label class="col-form-label">
                            <li>고객사</li>
                        </label>
                        <div class="form-group col">
                            <select id="companyName" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                        <label class="col-form-label" style="margin-left: 20px">
                            <li>사업장</li>
                        </label>
                        <div class="form-group col">
                            <select id="companyBranch" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row row">
                        <label class="col-form-label">
                            <li>진행상태</li>
                        </label>
                        <div class="form-group col">
                            <select id="reservationStatus" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                        <label class="col-form-label" style="margin-left: 20px">
                            <li>병원</li>
                        </label>
                        <div class="form-group col">
                            <select id="hospitalName" class="form-control">
                                <option selected>-전체-</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <div class="btn-save-square" style="float: right;" onclick="searchInformation()">
                        검색
                    </div>
                </ul>
            </form>
        </div>
    </div>

    <div class="row" style="margin-top:100px">
        <div class="col">
            <div class="d-flex justify-content-center px-5">
                <h6>
                    <div style="margin-right: 15px">통합검색</div>
                    <div class="search">
                        <input type="text" class="search-input" id="searchWord" placeholder="사원번호, 이름으로 검색하세요">
                        <div class="search-icon" onclick="searchInformation()"></div>
                    </div>
                </h6>
            </div>
        </div>
    </div>

    <div class="row " style="margin-left: 30px; margin-right: 30px; margin-top: 20px">
        <form class="table-responsive" style="margin: 0 auto">
            <div
                    class="btn-default-small excel" style="float: right"></div>
            <table id="reservationInfos" class="table table-hover" style="margin-top: 45px">
                <thead>
                <tr>
                    <th style="width: 3%">NO</th>
                    <th>서비스</th>
                    <th>고객사</th>
                    <th>사업장</th>
                    <th>아이디<br>(사번)</th>
                    <th>성명</th>
                    <th>등급</th>
                    <th style="width: 7%">생년월일</th>
                    <th style="width: 7%">검진병원</th>
                    <th style="width: 7%">연락처</th>
                    <th style="width: 7%">예약일</th>
                    <th>수검<br>상태</th>
                    <th>패키지</th>
                    <th>패키지<br>금액</th>
                    <th>지원금</th>
                    <th style="width: 5%">개인정보<br>동의<br>(듀얼)</th>
                    <th style="width: 5%">개인정보<br>동의<br>(병원)</th>
                    <th style="width: 5%">공단<br>차감</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </form>

    </div>

</div>
<!--콘텐츠 내용-->


<!-- 고객 상세 정보 Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog " style="max-width: 100%; width: auto; display: table;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container" style="margin-top: 20px">
                    <div class="menu-title" style="font-size: 22px; margin-bottom: 20px">
                        <img src="images/bg_h2_tit.png" style="margin-right: 10px;">
                        고객정보
                    </div>
                    <div class="row" style="width: 800px">
                        <div class="col">
                            <table class="table" id="info1">
                                <tbody>
                                <tr>
                                    <th>소속</th>
                                    <td id="cus-companyName"></td>
                                </tr>
                                <tr>
                                    <th>부서</th>
                                    <td id="cus-companyBranch"></td>
                                </tr>
                                <tr>
                                    <th>성명</th>
                                    <td id="cus-familyName" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>생년월일</th>
                                    <td id="cus-familyBirthDate" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>연락처</th>
                                    <td id="cus-familyPhone" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>주소</th>
                                    <td id="cus-familyAddress" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>이메일</th>
                                    <td id="cus-familyEmail" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>공단대상</th>
                                    <td id="cus-familyPcDiscount">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label" for="familyPcDiscountYes">YES&nbsp</label>
                                            <input class="form-check-input" type="checkbox" id="familyPcDiscountYes"
                                                   name="cus-familyPcDiscount" value="1" onclick="onlyCheck(this, name)">
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label" for="familyPcDiscountNo">NO&nbsp</label>
                                            <input class="form-check-input" type="checkbox" id="familyPcDiscountNo"
                                                   name="cus-familyPcDiscount" value="2" onclick="onlyCheck(this, name)">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>듀얼(동의)</th>
                                    <td id="cus-familyPsInfoDual">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label" for="familyPsInfoDualYes">YES&nbsp</label>
                                            <input class="form-check-input" type="checkbox" id="familyPsInfoDualYes"
                                                   name="cus-familyPsInfoDual" value="1" onclick="onlyCheck(this, name)">
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label" for="familyPsInfoDualNo">NO&nbsp</label>
                                            <input class="form-check-input" type="checkbox" id="familyPsInfoDualNo"
                                                   name="cus-familyPsInfoDual" value="2" onclick="onlyCheck(this, name)">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>병원(동의)</th>
                                    <td id="cus-familyPsInfoHos">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label" for="familyPsInfoHosYes">YES&nbsp</label>
                                            <input class="form-check-input" type="checkbox" id="familyPsInfoHosYes"
                                                   name="cus-familyPsInfoHos" value="1" onclick="onlyCheck(this, name)">
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label" for="familyPsInfoHosNo">NO&nbsp</label>
                                            <input class="form-check-input" type="checkbox" id="familyPsInfoHosNo"
                                                   name="cus-familyPsInfoHos" value="2" onclick="onlyCheck(this, name)">
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                            <div id="cus-packageReservation" style="font-size:14px; color: #5645ed"></div>
                            <div id="cus-packageInspection" style="font-size:14px; color: #5645ed"></div>

                            <table class="table" id="info2">
                                <tbody>
                                <tr>
                                    <th>1차 예약일</th>
                                    <td id="cus-reservationFirstWishDate" contentEditable="true"></td>
                                    <td style="width: 60px">
                                        <div
                                                class="btn-save-square"
                                                style="padding: 0; width: inherit; font-size: 13px"
                                                onclick="setIpDate(1)"> 확정
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>2차 예약일</th>
                                    <td id="cus-reservationSecondWishDate" contentEditable="true"></td>
                                    <td style="width: 60px">
                                        <div
                                                class="btn-save-square"
                                                style="padding: 0; width: inherit; font-size: 13px"
                                                onclick="setIpDate(2)"> 확정
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>예약 확정일</th>
                                    <td colspan="2" id="cus-ipDate" contentEditable="true"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col">
                            <table class="table" id="info3">
                                <tbody>
                                <tr>
                                    <th>예약서비스</th>
                                    <td id="cus-packageServiceName"></td>
                                </tr>
                                <tr>
                                    <th>병원</th>
                                    <td id="cus-packageHospitalName"></td>
                                </tr>
                                <tr>
                                    <th>패키지</th>
                                    <td id="cus-packageName"></td>
                                </tr>
                                <tr>
                                    <th>선택검사</th>
                                    <td id="cus-piiClassList"></td>
                                </tr>
                                <tr>
                                    <th>추가검사</th>
                                    <td id="cus-piiList"></td>
                                </tr>
                                </tbody>
                            </table>
                            <table class="table" id="info4">
                                <tbody>
                                <tr>
                                    <th>패키지금액</th>
                                    <td id="cus-packagePrice"></td>
                                </tr>
                                <tr>
                                    <th>회사지원금</th>
                                    <td id="cus-companySupportPrice" contentEditable="true"></td>
                                </tr>
                                <tr>
                                    <th>본인부담금</th>
                                    <td id="cus-customerPayedPrice"></td>
                                </tr>
                                </tbody>
                            </table>
                            <table class="table" id="info5">
                                <tbody>
                                <tr>
                                    <th>메모</th>
                                    <td id="cus-memo" contentEditable="true"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <div class="btn-save-square" style="float: right;" onclick="saveInformation()">저장</div>
            </div>
        </div>
    </div>
</div>

</body>
</html>

<script type="text/javascript">

    //검색항목리스트
    instance.post('M003001_RES').then(res => {
        setReservationSelectData(res.data);
    });


    //검색
    function searchInformation() {
        var searchItems = new Object();

        $('#reservationInfos > tbody').empty();

        searchItems.servedYear = $("#servedYear option:selected").val();
        searchItems.reservationServiceName = $("#reservationServiceName option:selected").val();
        searchItems.companyName = $("#companyName option:selected").val();
        searchItems.companyBranch = $("#companyBranch option:selected").val();
        searchItems.reservationStatus = $("#reservationStatus option:selected").val();
        searchItems.hospitalName = $("#hospitalName option:selected").val();

        searchItems.searchWord =  $("#searchWord").val();

        if (searchItems.servedYear == "-전체-") {
            searchItems.servedYear = "all";
        }
        if (searchItems.reservationServiceName == "-전체-") {
            searchItems.reservationServiceName = "all";
        }
        if (searchItems.companyName == "-전체-") {
            searchItems.companyName = "all";
        }
        if (searchItems.companyBranch == "-전체-") {
            searchItems.companyBranch = "all";
        }
        if (searchItems.reservationStatus == "-전체-") {
            searchItems.reservationStatus = "all";
        }
        if (searchItems.hospitalName == "-전체-") {
            searchItems.hospitalName = "all";
        }

        instance.post('M003002_REQ_RES', searchItems).then(res => {
            console.log(searchItems);
            setReservationData(res.data);
        });
    }

    //검색 selector
    function setReservationSelectData(data) {
        //수검연도
        for (i = 0; i < data.servedYear.length; i++) {
            var html = '';
            html += '<option>' + data.servedYear[i] + '</option>'
            $("#servedYear").append(html);
        }
        //병원별
        for (i = 0; i < data.reservationServiceName.length; i++) {
            var html = '';
            html += '<option>' + data.reservationServiceName[i] + '</option>'
            $("#reservationServiceName").append(html);
        }
        //회사
        if (data.companyName.length > 0) {
            //회사명 - 지점있을때
            var jbSplit = data.companyName[0].split('-');
            var companyName = jbSplit[0];
            var html = '';
            html += '<option>' + companyName + '</option>'
            $("#companyName").append(html);

            //지점
            for (i = 0; i < data.companyName.length; i++) {
                var jbSplit = data.companyName[i].split('-');
                var companyBranch = jbSplit[jbSplit.length - 1];
                var html = '';
                html += '<option>' + companyBranch + '</option>'
                $("#companyBranch").append(html);
            }
        } else {
            //회사명 - 지점없을때
            for (i = 0; i < data.companyName.length; i++) {
                var html = '';
                html += '<option>' + data.companyName[i] + '</option>'
                $("#companyName").append(html);
            }
        }
        //진행상태
        for (i = 0; i < data.reservationStatus.length; i++) {
            var html = '';
            html += '<option>' + data.reservationStatus[i] + '</option>'
            $("#reservationStatus").append(html);
        }
        //병원명
        for (i = 0; i < data.hospitalName.length; i++) {
            var html = '';
            html += '<option>' + data.hospitalName[i] + '</option>'
            $("#hospitalName").append(html);
        }
    }

    //체크박스 하나만 체크 되게
    function onlyCheck(chk, name) {
        var obj = document.getElementsByName(name);
        for(var i=0; i<obj.length; i++){
            if(obj[i] != chk){
                obj[i].checked = false;
            }
        }
    }

    //예약관리 테이블
    function setReservationData(data) {
        for (i = 0; i < data.length; i++) {
            var html = '';
            html += '<tr>"';
            html += '<td>' + data[i].id + '</td>';
            html += '<td>' + data[i].serviceName + '</td>';
            html += '<td>' + data[i].companyName + '</td>';
            html += '<td>' + data[i].companyBranch + '</td>';
            html += '<td data-toggle="modal" data-target="#customerModal" onClick="clickDetail(\'' + data[i].id + '\')">' + data[i].familyId + '</td>';
            html += '<td>' + data[i].familyName + '</td>';
            html += '<td>' + data[i].familyGrade + '</td>';
            html += '<td>' + data[i].familyBirthDate + '</td>';
            html += '<td>' + data[i].hospitalName + '</td>';
            html += '<td>' + data[i].familyPhone;
            html += '<td> 1차 ' + data[i].firstWishDate;
            html += '<p> 2차 ' + data[i].secondWishDate + '</td>';

            if (data[i].ipCheck) {
                html += '<td>Y</td>';
            } else {
                html += '<td>N</td>';
            }

            html += '<td>' + data[i].packageName + '</td>';
            html += '<td>' + data[i].packagePrice + '</td>';
            html += '<td>' + data[i].companySupportPrice + '</td>';

            if (data[i].familyPsInfoCheckDual) {
                html += '<td>Y</td>';
            } else {
                html += '<td>N</td>';
            }

            if (data[i].familyPsInfoCheckHos) {
                html += '<td>Y</td>';
            } else {
                html += '<td>N</td>';
            }

            if (data[i].familyPcDiscount) {
                html += '<td>Y</td>';
            } else {
                html += '<td>N</td>';
            }

            html += '</tr>';

            $("#reservationInfos").append(html);
        }
    }

    //고객정보상세
    var rsvId = Object();

    function clickDetail(data) {
        rsvId.reservationId = data;
        instance.post('M003003_REQ_RES', rsvId).then(res => {
            setDetailCostomerData(res.data);
        });
    }

    //클릭시 고객정보
    function setDetailCostomerData(data) {
        console.log(data);

        //info1
        document.getElementById('cus-companyName').innerHTML = data.companyName;
        document.getElementById('cus-companyBranch').innerHTML = data.companyBranch;
        document.getElementById('cus-familyName').innerHTML = data.familyName;
        document.getElementById('cus-familyBirthDate').innerHTML = data.familyBirthDate;
        document.getElementById('cus-familyPhone').innerHTML = data.familyPhone;
        document.getElementById('cus-familyAddress').innerHTML = data.familyAddress;
        document.getElementById('cus-familyEmail').innerHTML = data.familyEmail;

        if(data.familyPcDiscount) {
            $("input:checkbox[id='familyPcDiscountYes']").prop("checked", true);
            $("input:checkbox[id='familyPcDiscountNo']").prop("checked", false);
        } else {
            $("input:checkbox[id='familyPcDiscountYes']").prop("checked", false);
            $("input:checkbox[id='familyPcDiscountNo']").prop("checked", true);
        }
        if(data.familyPsInfoDual) {
            $("input:checkbox[id='familyPsInfoDualYes']").prop("checked", true);
            $("input:checkbox[id='familyPsInfoDualNo']").prop("checked", false);
        } else {
            $("input:checkbox[id='familyPsInfoDualYes']").prop("checked", false);
            $("input:checkbox[id='familyPsInfoDualNo']").prop("checked", true);
        }
        if(data.familyPsInfoHos) {
            $("input:checkbox[id='familyPsInfoHosYes']").prop("checked", true);
            $("input:checkbox[id='familyPsInfoHosNo']").prop("checked", false);
        } else {
            $("input:checkbox[id='familyPsInfoHosYes']").prop("checked", false);
            $("input:checkbox[id='familyPsInfoHosNo']").prop("checked", true);
        }

        //info2
        document.getElementById('cus-packageReservation').innerHTML
            = "예약기간 : " + data.packageReservationStartDate + " ~ " + data.packageReservationEndDate;
        document.getElementById('cus-packageInspection').innerHTML
            = "검진기간 : " + data.packageInspectionStartDate + " ~ " + data.packageInspectionEndDate;
        document.getElementById('cus-reservationFirstWishDate').innerHTML = data.reservationFirstWishDate;
        document.getElementById('cus-reservationSecondWishDate').innerHTML = data.reservationSecondWishDate;
        document.getElementById('cus-ipDate').innerHTML = data.ipDate;

        //info3
        document.getElementById('cus-packageServiceName').innerHTML = data.packageServiceName;
        document.getElementById('cus-packageHospitalName').innerHTML = data.packageHospitalName;
        document.getElementById('cus-packageName').innerHTML = data.packageName;
        document.getElementById('cus-piiClassList').innerHTML = data.piiClassList;
        document.getElementById('cus-piiList').innerHTML = data.piiList;

        //info4
        document.getElementById('cus-packagePrice').innerHTML = data.packagePrice;
        document.getElementById('cus-companySupportPrice').innerHTML = data.companySupportPrice;
        document.getElementById('cus-customerPayedPrice').innerHTML = data.customerPayedPrice;

        //info5
        document.getElementById('cus-memo').innerHTML = data.memo;
    }

    //예약확정일
    function setIpDate(num) {
        if (num == 1) {
            document.getElementById('cus-ipDate').innerHTML = document.getElementById('cus-reservationFirstWishDate').innerHTML;
        } else if (num == 2) {
            document.getElementById('cus-ipDate').innerHTML = document.getElementById('cus-reservationSecondWishDate').innerHTML;
        }
    }

    //수정된 정보로 저장
    function saveInformation() {
        var saveItems = new Object();

        saveItems.reservationId = rsvId.reservationId;
        saveItems.familyName = document.getElementById('cus-familyName').innerText;
        saveItems.familyBirthDate = document.getElementById('cus-familyBirthDate').innerText;
        saveItems.familyPhone = document.getElementById('cus-familyPhone').innerText;
        saveItems.familyAddress = document.getElementById('cus-familyAddress').innerText;
        saveItems.familyEmail = document.getElementById('cus-familyEmail').innerText;
        saveItems.familyPcDiscount = document.getElementById('cus-familyPcDiscount').innerText;
        saveItems.familyPsInfoDual = document.getElementById('cus-familyPsInfoDual').innerText;
        saveItems.familyPsInfoHos = document.getElementById('cus-familyPsInfoHos').innerText;
        saveItems.reservationFirstWishDate = document.getElementById('cus-reservationFirstWishDate').innerText;
        saveItems.reservationSecondWishDate = document.getElementById('cus-reservationSecondWishDate').innerText;
        saveItems.ipDate = document.getElementById('cus-ipDate').innerText;
        saveItems.companySupportPrice = document.getElementById('cus-companySupportPrice').innerText;
        saveItems.memo = document.getElementById('cus-memo').innerText;

        console.log(saveItems);

        if (confirm("저장하시겠습니까?") == true){
            instance.post('M003004_REQ_RES', saveItems).then(res => {
                console.log(res.data.message);
                alert("저장되었습니다.");
                clickDetail(saveItems.reservationId);
            });
        }else{
            return false;
        }
    }
</script>
